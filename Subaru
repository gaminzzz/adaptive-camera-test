local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local TweenService = game:GetService("TweenService")

local player = Players.LocalPlayer
local diedCFrame = nil
local isReviving = false
local heartbeatConnection = nil

-- Setup revive sound
local reviveSound = Instance.new("Sound")
reviveSound.SoundId = "rbxassetid://18597544476"
reviveSound.Volume = 1
reviveSound.Name = "ReviveSound"
reviveSound.Parent = workspace

-- Setup screen flash GUI
local flashGui = Instance.new("ScreenGui")
flashGui.Name = "ReviveFlashGui"
flashGui.ResetOnSpawn = false
flashGui.IgnoreGuiInset = true
flashGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
flashGui.Parent = player:WaitForChild("PlayerGui")

local flashImage = Instance.new("ImageLabel")
flashImage.Name = "FlashImage"
flashImage.BackgroundTransparency = 1
flashImage.ImageTransparency = 1
flashImage.Size = UDim2.new(1, 0, 1, 0)
flashImage.Position = UDim2.new(0, 0, 0, 0)
flashImage.Image = "rbxassetid://94406762340192"
flashImage.ScaleType = Enum.ScaleType.Stretch
flashImage.Parent = flashGui

-- Function to play flash effect
local function playFlash()
	flashImage.ImageTransparency = 0 -- Fade in instantly

	-- Short delay helps ensure it's rendered
	wait(0.05)

	-- Fade out over 2 seconds
	local tween = TweenService:Create(flashImage, TweenInfo.new(2, Enum.EasingStyle.Linear), {
		ImageTransparency = 1
	})
	tween:Play()
end

-- Function to revive the player at last known CFrame
local function reviveCharacter()
	if not diedCFrame or not player.Character then return end

	isReviving = true
	wait(0.1) -- Let core systems settle

	local hrp = player.Character:WaitForChild("HumanoidRootPart")
	hrp.CFrame = diedCFrame -- Restore position + orientation

	reviveSound:Play()
	playFlash()

	isReviving = false
end

-- Character handler
local function onCharacterAdded(character)
	local humanoid = character:WaitForChild("Humanoid")
	local hrp = character:WaitForChild("HumanoidRootPart")

	-- Disconnect old heartbeat
	if heartbeatConnection then
		heartbeatConnection:Disconnect()
	end

	-- Track position + orientation
	heartbeatConnection = RunService.Heartbeat:Connect(function()
		if humanoid and humanoid.Health > 0 and not isReviving then
			diedCFrame = hrp.CFrame
		end
	end)

	humanoid.Died:Connect(function()
		wait(0.1)
		local newChar = player.CharacterAdded:Wait()
		newChar:WaitForChild("HumanoidRootPart")

		reviveCharacter()
	end)
end

-- Initial setup
if player.Character then
	onCharacterAdded(player.Character)
end
player.CharacterAdded:Connect(onCharacterAdded)
