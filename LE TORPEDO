local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local player = Players.LocalPlayer
local camera = workspace.CurrentCamera

local torpedoMode = false
local moveForward = false
local speed = 80
local spinSpeed = 5

-- Helper to get character safely
local function getCharacter()
	local char = player.Character or player.CharacterAdded:Wait()
	local hrp = char:FindFirstChild("HumanoidRootPart")
	local humanoid = char:FindFirstChildOfClass("Humanoid")
	if not (char and hrp and humanoid) then return nil end
	return char, hrp, humanoid
end

-- Enter torpedo mode
local function enterTorpedo()
	local char, hrp, humanoid = getCharacter()
	if not hrp or not humanoid then return end

	torpedoMode = true
	humanoid.PlatformStand = true

	RunService:BindToRenderStep("TorpedoR6Control", Enum.RenderPriority.Character.Value, function(dt)
		if not torpedoMode then return end

		local camLook = camera.CFrame.LookVector
		local position = hrp.Position

		-- Point the player in the direction of the camera
		local lookCFrame = CFrame.lookAt(position, position + camLook)
		local tilt = CFrame.Angles(math.rad(90), 0, 0) -- Face down
		local spin = CFrame.Angles(0, 0, tick() * spinSpeed)

		-- Combine for spin-tilt-forward effect
		hrp.CFrame = lookCFrame * tilt * spin

		-- Move forward only when 'W' is held
		if moveForward then
			hrp.Velocity = camLook * speed
		else
			hrp.Velocity = Vector3.zero
		end
	end)
end

-- Exit torpedo mode
local function exitTorpedo()
	local char, hrp, humanoid = getCharacter()
	if not hrp or not humanoid then return end

	torpedoMode = false
	humanoid.PlatformStand = false
	RunService:UnbindFromRenderStep("TorpedoR6Control")
end

-- Key press logic
UIS.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end

	if input.KeyCode == Enum.KeyCode.Z then
		if torpedoMode then
			exitTorpedo()
		else
			enterTorpedo()
		end
	elseif input.KeyCode == Enum.KeyCode.W then
		moveForward = true
	end
end)

UIS.InputEnded:Connect(function(input)
	if input.KeyCode == Enum.KeyCode.W then
		moveForward = false
	end
end)
